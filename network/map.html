<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Smability Network</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    <link href="assets/css/map.css" rel="stylesheet" />
    <link href="assets/css/smability-panels.css" rel="stylesheet" />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <div id="map"></div>
    
    <!-- Chart Panel - IMPROVED STRUCTURE -->
    <div id="chartPanel" class="chart-panel" style="display: none;">
        <div class="chart-panel-header">
            <!-- Close Button - Top Right Corner -->
            <button class="chart-panel-close" onclick="closeChartPanel()">√ó</button>
            
            <!-- Device Info Container will be created dynamically by JavaScript -->
            
            <!-- Legacy select container - kept for compatibility but hidden -->
            <div class="select-container" style="display: none;">
                <select id="sensorSelect-legacy" class="panel-select">
                    <option value="7">Ozone (ppb)</option>
                    <option value="2">Carbon Monoxide (ppb)</option>
                    <option value="9">PM2.5 (Œºg/m¬≥)</option>
                    <option value="12">Temperature (¬∞C)</option>
                    <option value="3">Relative Humidity (%)</option>
                </select>
                <select id="timeframeSelect-legacy" class="panel-select">
                    <option value="168">Last 7 days</option>
                    <option value="24">Last 24 hours</option>
                    <option value="12">Last 12 hours</option>
                    <option value="8">Last 8 hours</option>
                    <option value="4">Last 4 hours</option>
                </select>
            </div>
        </div>
        <div class="chart-container">
            <div id="iasChart"></div>
        </div>
        <!-- Branding del panel -->
        <div class="chart-panel-branding">
            <small><a href="http://www.smability.io" target="_blank" class="brand-text">smability.io</a></small>
        </div>
    </div>

    <!-- WhatsApp Float Button -->
    <a href="https://wa.me/525519566483" target="_blank" class="whatsapp-float-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
    </a>

    <!-- AIre Float Button -->
    <a href="https://smability.netlify.app/" target="_blank" class="ai-float-button">
        <span>AIre</span>
    </a>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/sensors.js"></script>
    <script src="assets/js/chart.js"></script>
    <script src="assets/js/map.js"></script>
<!-- ==============================================
     ARCHIVO: smability-panels.html - VERSI√ìN COMPLETA
     DESCRIPCI√ìN: Panel √∫nico expandible con gr√°fico inline
     INTEGRACI√ìN: Agregar al final del <body> de map.html
     ============================================== -->

<!-- Nuevos Paneles Smability - Panel √∫nico expandible -->
<div id="smabilityPanelContainer" style="display: none;">
    <!-- Panel Principal Smability - Expandible -->
    <div class="smability-main-panel" id="smabilityMainPanel" style="display: none;">
        <div class="smability-panel-header">
            <div class="smability-header-left">
                <h3 class="smability-panel-title" id="smabilityPanelTitle">CENTRUS 5</h3>
                <!-- AGREGADO: Air Quality en el header -->
                <p class="smability-air-quality-label"></p>
            </div>
            <div class="smability-header-right">
                <!-- WhatsApp en el header del panel - LINK CORRECTO -->
                <a href="https://wa.me/525519566483" target="_blank" class="smability-whatsapp-popup">
                    <svg viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    AIreGPT
                </a>
                <button class="smability-panel-close" onclick="SmabilityPanels.closeMainPanel()">√ó</button>
            </div>
        </div>

         <!-- NUEVA: Barra IAS -->
        <div class="smability-ias-bar-container">
            <div class="smability-ias-bar" id="smabilityIasBar"></div>
            <div class="smability-ias-bar-labels">
                <span class="smability-ias-bar-label">Good<br>0-50</span>
                <span class="smability-ias-bar-label">Moderate<br>51-100</span>
                <span class="smability-ias-bar-label">Unhealthy<br>101-150</span>
                <span class="smability-ias-bar-label">Very Bad<br>151-200</span>
                <span class="smability-ias-bar-label">Extreme<br>201+</span>
            </div>
        </div>
        
        <div class="smability-panel-content">
            <!-- IAS Principal con etiquetas actualizadas -->
            <div class="smability-ias-section smability-clickable" id="smabilityIasSection" onclick="SmabilityPanels.toggleDetails()">
                <span class="smability-ias-emoji" id="smabilityIasEmoji">üòê</span>
                <span class="smability-ias-indicator" id="smabilityIasIndicator"></span>
                <span class="smability-ias-value" id="smabilityIasValue">87</span>
                <div class="smability-ias-status">
                    <div class="smability-status-row">
                        <span class="smability-status-label">Air Quality:</span>
                        <span class="smability-status-value" id="smabilityStatusText1">Acceptable</span>
                    </div>
                    <div class="smability-status-row">
                        <span class="smability-status-label">Risk:</span>
                        <span class="smability-status-value" id="smabilityStatusText2">Moderate</span>
                    </div>
                </div>
            </div>
            
            <!-- Datos expandidos (inicialmente ocultos) -->
            <div class="smability-expanded-content" id="smabilityExpandedContent" style="display: none;">
            
            <!-- Datos en grid -->
            <div class="smability-data-grid">
                <div class="smability-data-item">
                    <div class="smability-data-label">Dominant Pollutant</div>
                    <div class="smability-data-value" id="smabilityDominantPollutant">O3</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">O3 1hr</div>
                    <div class="smability-data-value" id="smabilityO3">50.75 ppb</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">CO 8hr</div>
                    <div class="smability-data-value" id="smabilityCO">424.2 ppb</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">PM2.5 12hr</div>
                    <div class="smability-data-value" id="smabilityPM25">3.2 ug/m3</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">PM10 12hr</div>
                    <div class="smability-data-value" id="smabilityPM10">4 ug/m3</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">Temperature</div>
                    <div class="smability-data-value" id="smabilityTemperature">31 ¬∞C</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">Humidity</div>
                    <div class="smability-data-value" id="smabilityHumidity">29.3 %</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">Battery</div>
                    <div class="smability-data-value" id="smabilityBattery">99 %</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">Location</div>
                    <div class="smability-data-value" id="smabilityLocation">Outdoors</div>
                </div>
                <div class="smability-data-item">
                    <div class="smability-data-label">Device Mode</div>
                    <div class="smability-data-value" id="smabilityDeviceMode">Fix</div>
                </div>
            </div>

            <!-- Bot√≥n de gr√°fico -->
            <div class="smability-action-buttons">
                <button class="smability-btn" onclick="SmabilityPanels.toggleChart()">üìä View Historical Data</button>
            </div>

            <!-- NUEVO: Contenedor de gr√°fico inline -->
            <div class="smability-inline-chart-container" id="smabilityInlineChartContainer" style="display: none;">
                <div class="smability-inline-chart-header">
                    <!-- ELIMINADO: T√≠tulo del gr√°fico ya no se muestra -->
                    <div class="smability-inline-chart-controls">
                        <label>Compare:</label>
                        <select id="smabilityComparisonSelect">
                            <option value="">None</option>
                            <option value="Hip√≥dromo">Hip√≥dromo</option>
                            <option value="UNAM">UNAM</option>
                            <option value="CENTRUS 3">CENTRUS 3</option>
                            <option value="INSYC-Smability">INSYC-Smability</option>
                        </select>
                        <label>Sensor:</label>
                        <select id="smabilitySensorSelect">
                            <option value="7">Ozone (ppb)</option>
                            <option value="2">Carbon Monoxide (ppb)</option>
                            <option value="9">PM2.5 (Œºg/m¬≥)</option>
                            <option value="12">Temperature (¬∞C)</option>
                            <option value="3">Relative Humidity (%)</option>
                        </select>
                        <label>Period:</label>
                        <select id="smabilityTimeframeSelect">
                            <option value="4">Last 4 hours</option>
                            <option value="8">Last 8 hours</option>
                            <option value="12">Last 12 hours</option>
                            <option value="24">Last 24 hours</option>
                        </select>
                    </div>
                </div>
                <div class="smability-inline-chart-area">
                    <!-- AGREGADO: Contenedor para gr√°fico real de Plotly -->
                    <div id="smabilityInlineChart" style="width: 100%; height: 200px; display: none;"></div>
                    <!-- Placeholder se muestra solo cuando no hay gr√°fico -->
                    <div class="smability-chart-placeholder" id="smabilityChartPlaceholder">
                        üìä Plotly.js Chart with Real-time Data<br>
                        <small style="margin-top: 8px; display: block;">Optimized for air quality visualization</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer del panel principal -->
        <div class="smability-panel-footer">
            <span class="smability-last-update">Last update: 2 min ago</span>
            <span class="smability-branding"><a href="https://smability.io/en/" target="_blank" style="color: #4264fb; text-decoration: none;">smability.io</a></span>
        </div>
    </div>
</div>
<script src="assets/js/smability-panels.js"></script>
<script>
    
let smabilityInitAttempts = 0;
const maxSmabilityAttempts = 10;

function ensureSmabilityMarkers() {
    smabilityInitAttempts++;
    
    // CR√çTICO: L√≠mite de intentos
    if (smabilityInitAttempts > maxSmabilityAttempts) {
        console.error('‚ùå ensureSmabilityMarkers: Max attempts reached, STOPPING');
        return;
    }
    
    console.log(`üîç ensureSmabilityMarkers attempt ${smabilityInitAttempts}/${maxSmabilityAttempts}`);
    
    if (window.map && 
        typeof window.map.isStyleLoaded === 'function' && 
        window.map.isStyleLoaded() && 
        window.SmabilityPanels) {
        
        console.log('‚úÖ All ready, initializing SmabilityPanels...');
        try {
            window.SmabilityPanels.init();
        } catch (error) {
            console.error('‚ùå Error initializing:', error);
        }
    } else {
        console.log('‚è≥ Not ready, will retry...');
        setTimeout(ensureSmabilityMarkers, 500);
    }
}

setTimeout(ensureSmabilityMarkers, 2000);
setTimeout(ensureSmabilityMarkers, 5000);

document.addEventListener('click', (e) => {
    if (e.target.textContent === 'Smability Panels' && 
        e.target.style.backgroundColor === 'rgb(66, 100, 251)') {
        setTimeout(ensureSmabilityMarkers, 100);
    }
});
</script>
<!-- ============================================================================ -->
<!-- MASTER API INTEGRATION SCRIPT - AGREGAR ANTES DEL CIERRE </body> -->
<!-- Script completo para testing con solo Tultitl√°n (TLI) -->
<!-- ============================================================================ -->

<script>
// ============================================================================
// MASTER API FUNCTIONS - COMPLETAS
// ============================================================================

/**
 * Fetch data from Master API
 * @returns {Promise<Array>} Array of station data
 */
async function fetchMasterAPIData() {
    const now = Date.now();
    
    // Check cache first
    if (window.MASTER_API_CONFIG.lastFetch && 
        (now - window.MASTER_API_CONFIG.lastFetch) < window.MASTER_API_CONFIG.cacheTimeout &&
        window.MASTER_API_CONFIG.cache.has('all_stations')) {
        console.log('üìã Using cached Master API data');
        window.logSchedule('Using cached data');
        return window.MASTER_API_CONFIG.cache.get('all_stations');
    }

    try {
        console.log('üåê Fetching from Master API...');
        window.logSchedule('Fetching fresh data from API');
        
        const params = new URLSearchParams(window.MASTER_API_CONFIG.params);
        const url = `${window.MASTER_API_CONFIG.baseUrl}?${params.toString()}`;
        
        console.log('üìç API URL:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Master API failed with status: ${response.status}`);
        }

        const data = await response.json();
        console.log('üìä Master API response received:', data.length, 'stations');

        // Log all stations received for debugging
        console.log('üìã All stations from API:');
        data.forEach((station, index) => {
            if (index < 5) { // Show first 5 for debugging
                console.log(`  ${index + 1}. ${station.station_id} (${station.station_name}) - Type: ${station.device_type} - IAS: ${station.ias_numeric_value}`);
            }
        });
        if (data.length > 5) {
            console.log(`  ... and ${data.length - 5} more stations`);
        }

        // Filtrar solo estaciones reference
        const referenceStations = data.filter(station => 
            station.device_type === 'reference'
        );

        console.log(`‚úÖ Filtered ${referenceStations.length} reference stations from ${data.length} total`);
        
        // Log reference stations found
        console.log('üéØ Reference stations found:');
        referenceStations.forEach(station => {
            const isMapped = window.REFERENCE_STATION_MAPPING[station.station_id];
            console.log(`  - ${station.station_id} (${station.station_name}) - IAS: ${station.ias_numeric_value}, Color: ${station.color_code} ${isMapped ? '‚úÖ MAPPED' : '‚ö†Ô∏è NOT MAPPED'}`);
        });
        
        // Check specifically for Tultitl√°n
        const tultitlanStation = referenceStations.find(s => s.station_id === 'TLI');
        if (tultitlanStation) {
            console.log('üéØ TULTITL√ÅN FOUND:', tultitlanStation);
            window.logSchedule('Tultitl√°n station found', {
                station_id: tultitlanStation.station_id,
                ias: tultitlanStation.ias_numeric_value,
                color: tultitlanStation.color_code,
                status: tultitlanStation.reading_status
            });
        } else {
            console.warn('‚ö†Ô∏è TULTITL√ÅN (TLI) NOT FOUND in reference stations');
            window.logSchedule('Tultitl√°n station NOT found');
        }
        
        // Cache the results
        window.MASTER_API_CONFIG.cache.set('all_stations', referenceStations);
        window.MASTER_API_CONFIG.lastFetch = now;

        return referenceStations;

    } catch (error) {
        console.error('‚ùå Error fetching Master API data:', error);
        window.logSchedule('API fetch error', error.message);
        
        // Return cached data if available, even if expired
        if (window.MASTER_API_CONFIG.cache.has('all_stations')) {
            console.log('‚ö†Ô∏è Using expired cache due to fetch error');
            window.logSchedule('Using expired cache due to error');
            return window.MASTER_API_CONFIG.cache.get('all_stations');
        }
        
        return [];
    }
}

/**
 * Process Master API data and update reference station squares
 */
async function updateReferenceStations() {
    try {
        console.log('üîÑ Starting reference stations update...');
        window.logSchedule('Starting station update process');
        
        const stations = await fetchMasterAPIData();
        
        if (!stations.length) {
            console.log('‚ö†Ô∏è No reference stations data available');
            window.logSchedule('No stations data available');
            return;
        }

        console.log(`üìç Processing ${stations.length} reference stations`);
        
        // Update square markers for each reference station
        let updatedCount = 0;
        let mappedCount = 0;
        
        stations.forEach(station => {
            const isMapped = window.REFERENCE_STATION_MAPPING[station.station_id];
            if (isMapped) {
                mappedCount++;
                const updated = updateReferenceStationSquare(station);
                if (updated) updatedCount++;
            } else {
                console.log(`‚ö†Ô∏è Station ${station.station_id} not in mapping, skipping`);
            }
        });

        console.log(`‚úÖ Reference stations update complete: ${updatedCount}/${mappedCount} mapped stations updated`);
        window.logSchedule('Update complete', {
            total: stations.length,
            mapped: mappedCount,
            updated: updatedCount
        });

    } catch (error) {
        console.error('‚ùå Error updating reference stations:', error);
        window.logSchedule('Update error', error.message);
    }
}

/**
 * Update individual reference station square marker
 * @param {Object} stationData - Station data from Master API
 * @returns {boolean} - Whether the update was successful
 */
function updateReferenceStationSquare(stationData) {
    const { station_id, station_name, ias_numeric_value, color_code, category, reading_status } = stationData;
    
    try {
        console.log(`üéØ Updating station: ${station_id} (${station_name})`);
        
        // Verificar que el mapa y las capas existen
        if (!window.map || !window.map.getLayer || !window.map.getLayer('smaa_network_squares')) {
            console.log(`‚ö†Ô∏è Map or smaa_network_squares layer not ready for ${station_id}`);
            return false;
        }

        // Buscar features que coincidan con este station_id o station_name
        let features = [];
        
        // Intentar con station_id primero
        try {
            features = window.map.querySourceFeatures(window.MAP_LAYERS.source, {
                sourceLayer: window.MAP_LAYERS.sourceLayer,
                filter: ['==', 'name', station_id]
            });
            console.log(`üîç Query with station_id '${station_id}': ${features.length} features found`);
        } catch (queryError) {
            console.log(`‚ö†Ô∏è Error querying with station_id ${station_id}:`, queryError);
        }

        // Si no encuentra con station_id, intentar con station_name
        if (features.length === 0) {
            try {
                features = window.map.querySourceFeatures(window.MAP_LAYERS.source, {
                    sourceLayer: window.MAP_LAYERS.sourceLayer,
                    filter: ['==', 'name', station_name]
                });
                console.log(`üîç Query with station_name '${station_name}': ${features.length} features found`);
            } catch (queryError) {
                console.log(`‚ö†Ô∏è Error querying with station_name ${station_name}:`, queryError);
            }
        }

        // Si a√∫n no encuentra, intentar con mapeo
        if (features.length === 0 && window.REFERENCE_STATION_MAPPING[station_id]) {
            const mappedName = window.REFERENCE_STATION_MAPPING[station_id];
            try {
                features = window.map.querySourceFeatures(window.MAP_LAYERS.source, {
                    sourceLayer: window.MAP_LAYERS.sourceLayer,
                    filter: ['==', 'name', mappedName]
                });
                console.log(`üîç Query with mapped name '${mappedName}': ${features.length} features found`);
            } catch (queryError) {
                console.log(`‚ö†Ô∏è Error querying with mapped name ${mappedName}:`, queryError);
            }
        }

        // DEBUG: Si a√∫n no encuentra, mostrar todas las features disponibles
        if (features.length === 0) {
            console.log(`üîç No features found for ${station_id}. Debugging available features...`);
            try {
                const allFeatures = window.map.querySourceFeatures(window.MAP_LAYERS.source, {
                    sourceLayer: window.MAP_LAYERS.sourceLayer
                });
                console.log(`üìã Total features in layer: ${allFeatures.length}`);
                
                // Mostrar primeras 10 features para debug
                const sampleFeatures = allFeatures.slice(0, 10);
                console.log('üìã Sample feature names:');
                sampleFeatures.forEach((f, index) => {
                    console.log(`  ${index + 1}. "${f.properties.name}"`);
                });
                
                // Buscar nombres similares
                const similarNames = allFeatures.filter(f => 
                    f.properties.name && (
                        f.properties.name.toLowerCase().includes('tul') ||
                        f.properties.name.toLowerCase().includes('tli') ||
                        f.properties.name.toLowerCase().includes('tultitlan')
                    )
                );
                
                if (similarNames.length > 0) {
                    console.log('üîç Similar names found:');
                    similarNames.forEach(f => {
                        console.log(`  - "${f.properties.name}"`);
                    });
                }
                
            } catch (debugError) {
                console.log('‚ùå Error during debug query:', debugError);
            }
            
            console.log(`‚ùå No map feature found for station: ${station_id} (${station_name})`);
            return false;
        }

        console.log(`üéØ Found ${features.length} feature(s) for ${station_id}`);

        // Determinar qu√© mostrar basado en reading_status
        let displayText, textColor;
        
        if (reading_status === 'current' && ias_numeric_value) {
            // Mostrar valor IAS si los datos son actuales
            displayText = Math.round(ias_numeric_value).toString();
            textColor = getContrastColor(color_code);
            console.log(`üìä Displaying IAS: ${displayText} with color: ${color_code} (text: ${textColor})`);
        } else {
            // Mostrar indicador de estado si no hay datos actuales
            displayText = reading_status === 'stale' ? '‚óã' : '√ó';
            textColor = '#ffffff';
            console.log(`‚ö†Ô∏è Displaying status: ${displayText} (${reading_status})`);
        }

        // Crear el identificador √∫nico para esta estaci√≥n
        const stationIdentifiers = [station_id, station_name];
        if (window.REFERENCE_STATION_MAPPING[station_id]) {
            stationIdentifiers.push(window.REFERENCE_STATION_MAPPING[station_id]);
        }

        console.log(`üè∑Ô∏è Station identifiers: [${stationIdentifiers.join(', ')}]`);

        // Actualizar propiedades del mapa
        try {
            console.log(`üé® Updating map properties for identifiers: ${stationIdentifiers}`);
            
            // Actualizar color de texto del square
            window.map.setPaintProperty('smaa_network_squares', 'text-color', [
                'case',
                ['in', ['get', 'name'], ['literal', stationIdentifiers]],
                textColor,
                '#666666' // color por defecto
            ]);

            // Actualizar texto mostrado
            window.map.setLayoutProperty('smaa_network_squares', 'text-field', [
                'case',
                ['in', ['get', 'name'], ['literal', stationIdentifiers]],
                displayText,
                '‚ñ†' // s√≠mbolo por defecto
            ]);

            // Agregar fondo de color IAS usando halo
            if (reading_status === 'current' && color_code) {
                window.map.setPaintProperty('smaa_network_squares', 'text-halo-color', [
                    'case',
                    ['in', ['get', 'name'], ['literal', stationIdentifiers]],
                    color_code,
                    'rgba(0,0,0,0)' // transparente por defecto
                ]);

                window.map.setPaintProperty('smaa_network_squares', 'text-halo-width', [
                    'case',
                    ['in', ['get', 'name'], ['literal', stationIdentifiers]],
                    4, // Halo m√°s prominente
                    0 // sin halo por defecto
                ]);
                
                console.log(`üé® Applied halo color: ${color_code} with width: 4`);
            }

            console.log(`‚úÖ Successfully updated square for ${station_id}: ${displayText} (${color_code})`);
            return true;

        } catch (mapError) {
            console.error(`‚ùå Error updating map layer for ${station_id}:`, mapError);
            return false;
        }

    } catch (error) {
        console.error(`‚ùå Error processing station ${station_id}:`, error);
        return false;
    }
}

/**
 * Get contrasting text color (white or black) based on background color
 * @param {string} hexColor - Background color in hex format
 * @returns {string} - Text color (white or black)
 */
function getContrastColor(hexColor) {
    try {
        if (!hexColor) return '#ffffff';
        
        // Remove # if present
        const hex = hexColor.replace('#', '');
        
        // Handle 3-digit hex codes
        let r, g, b;
        if (hex.length === 3) {
            r = parseInt(hex.charAt(0) + hex.charAt(0), 16);
            g = parseInt(hex.charAt(1) + hex.charAt(1), 16);
            b = parseInt(hex.charAt(2) + hex.charAt(2), 16);
        } else {
            r = parseInt(hex.substr(0, 2), 16);
            g = parseInt(hex.substr(2, 2), 16);
            b = parseInt(hex.substr(4, 2), 16);
        }
        
        // Calculate luminance
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        
        // Return black for light backgrounds, white for dark
        return luminance > 0.5 ? '#000000' : '#ffffff';
    } catch (error) {
        console.error('Error calculating contrast color:', error);
        return '#ffffff'; // Default to white
    }
}

// ============================================================================
// SCHEDULING SYSTEM
// ============================================================================

/**
 * Initialize Master API integration con scheduling espec√≠fico
 */
function initializeMasterAPI() {
    console.log('üöÄ Initializing Master API integration with hourly scheduling...');
    
    // Verificar que el mapa est√© completamente cargado
    if (window.map && window.map.isStyleLoaded && window.map.isStyleLoaded()) {
        console.log('üó∫Ô∏è Map is ready, starting Master API scheduled updates...');
        
        // Log de configuraci√≥n inicial
        if (window.logSchedule) {
            window.logSchedule('Initialization started');
            window.logSchedule('Update schedule', window.MASTER_API_CONFIG.scheduleConfig.updateMinutes);
            window.logSchedule('Testing with station TLI (Tultitl√°n)');
        }
        
        // Primera actualizaci√≥n inmediata (con delay inicial)
        setTimeout(() => {
            console.log('üîÑ Running initial Master API update...');
            if (window.logSchedule) {
                window.logSchedule('Running initial update');
            }
            updateReferenceStations();
        }, window.MASTER_API_CONFIG.scheduleConfig.initialDelay);

        // Configurar el sistema de scheduling
        setupHourlyScheduling();

        console.log('‚úÖ Master API integration initialized with hourly scheduling at minutes:', 
                   window.MASTER_API_CONFIG.scheduleConfig.updateMinutes);
    } else {
        console.log('‚è≥ Map not ready for Master API, retrying in 2 seconds...');
        setTimeout(initializeMasterAPI, 2000);
    }
}

/**
 * Configurar sistema de scheduling para actualizaciones en minutos espec√≠ficos de cada hora
 */
function setupHourlyScheduling() {
    console.log('‚è∞ Setting up hourly scheduling system...');
    
    function scheduleNextUpdate() {
        const scheduleInfo = window.getTimeUntilNextScheduledUpdate();
        const timeUntilNext = scheduleInfo.timeUntilNext;
        const targetTime = scheduleInfo.targetTime;
        const targetMinute = scheduleInfo.targetMinute;
        
        if (window.logSchedule) {
            window.logSchedule(`Next update scheduled for ${window.formatTimeForLogging(targetTime)} (minute ${targetMinute})`);
            window.logSchedule(`Time until next update: ${Math.round(timeUntilNext / 1000)} seconds`);
        }
        
        // Programar la pr√≥xima actualizaci√≥n
        setTimeout(async () => {
            // Ejecutar la actualizaci√≥n
            if (window.logSchedule) {
                window.logSchedule(`Executing scheduled update at minute ${targetMinute}`);
            }
            
            console.log(`‚è∞ Scheduled Master API update at minute ${targetMinute}`);
            await updateReferenceStations();
            
            // Programar la siguiente actualizaci√≥n
            scheduleNextUpdate();
            
        }, timeUntilNext);
    }
    
    // Iniciar el sistema de scheduling
    scheduleNextUpdate();
    
    // Configurar fallback timer (cada 30 minutos) por si falla el scheduling
    setInterval(() => {
        if (window.logSchedule) {
            window.logSchedule('Fallback update triggered');
        }
        console.log('üîÑ Fallback Master API update (every 30 min)...');
        updateReferenceStations();
    }, window.MASTER_API_CONFIG.scheduleConfig.fallbackInterval);
    
    console.log('‚úÖ Hourly scheduling system configured');
}

// ============================================================================
// TESTING AND DEBUG FUNCTIONS
// ============================================================================

/**
 * Manual trigger for testing con logging mejorado
 */
function testMasterAPI() {
    console.log('üß™ Manual Master API test triggered...');
    if (window.logSchedule) {
        window.logSchedule('Manual test triggered');
    }
    updateReferenceStations();
}

/**
 * Test function para probar el sistema de scheduling
 */
function testScheduling() {
    console.log('üß™ Testing scheduling system...');
    if (window.debugScheduling) {
        window.debugScheduling();
    } else {
        console.log('‚ùå debugScheduling function not available');
    }
}

/**
 * Debug function to check current map state
 */
function debugMapState() {
    console.log('=== MAP STATE DEBUG ===');
    console.log('Map exists:', !!window.map);
    console.log('Map loaded:', window.map && window.map.isStyleLoaded ? window.map.isStyleLoaded() : 'unknown');
    console.log('smaa_network_squares layer exists:', window.map && window.map.getLayer ? !!window.map.getLayer('smaa_network_squares') : 'unknown');
    
    if (window.map && window.MAP_LAYERS) {
        try {
            const allFeatures = window.map.querySourceFeatures(window.MAP_LAYERS.source, {
                sourceLayer: window.MAP_LAYERS.sourceLayer
            });
            console.log('Total features in source:', allFeatures.length);
            
            // Sample de nombres de features
            const sampleNames = allFeatures.slice(0, 10).map(f => f.properties.name);
            console.log('Sample feature names:', sampleNames);
            
            // Buscar espec√≠ficamente Tultitl√°n
            const tultitlanFeatures = allFeatures.filter(f => 
                f.properties.name && (
                    f.properties.name.toLowerCase().includes('tul') ||
                    f.properties.name === 'TLI' ||
                    f.properties.name === 'Tultitl√°n'
                )
            );
            console.log('Tultitl√°n-related features:', tultitlanFeatures.map(f => f.properties.name));
            
        } catch (error) {
            console.log('Error querying features:', error);
        }
    }
    console.log('=======================');
}

/**
 * Funci√≥n para simular diferentes horarios (solo para testing)
 * @param {number} hour - Hora a simular (0-23)
 * @param {number} minute - Minuto a simular (0-59)
 */
function simulateTimeAndTest(hour, minute) {
    console.log(`üïê Simulating time: ${hour}:${minute.toString().padStart(2, '0')}`);
    
    // Crear fecha simulada
    const simulatedNow = new Date();
    simulatedNow.setHours(hour);
    simulatedNow.setMinutes(minute);
    simulatedNow.setSeconds(0);
    
    // Temporalmente sobrescribir Date para la simulaci√≥n
    const originalNow = Date;
    window.Date = function(...args) {
        if (args.length === 0) {
            return simulatedNow;
        }
        return new originalNow(...args);
    };
    window.Date.now = () => simulatedNow.getTime();
    
    // Probar el scheduling
    const scheduleInfo = window.getTimeUntilNextScheduledUpdate();
    console.log('üìä Simulation results:');
    console.log('  Next update minute:', scheduleInfo.targetMinute);
    console.log('  Time until next:', Math.round(scheduleInfo.timeUntilNext / 1000), 'seconds');
    console.log('  Target time:', window.formatTimeForLogging(scheduleInfo.targetTime));
    
    // Restaurar Date original
    window.Date = originalNow;
}

/**
 * Test completo de toda la funcionalidad
 */
function runCompleteTest() {
    console.log('üß™ Running complete Master API test...');
    console.log('=====================================');
    
    // 1. Test configuraci√≥n
    console.log('1. Testing configuration...');
    if (window.debugMasterAPIConfig) {
        window.debugMasterAPIConfig();
    }
    
    // 2. Test scheduling
    console.log('2. Testing scheduling...');
    testScheduling();
    
    // 3. Test map state
    console.log('3. Testing map state...');
    debugMapState();
    
    // 4. Test API call
    console.log('4. Testing API call...');
    testMasterAPI();
    
    // 5. Test time simulations
    console.log('5. Testing time simulations...');
    simulateTimeAndTest(10, 5);   // Should go to 10:15
    simulateTimeAndTest(10, 17);  // Should go to 10:20
    simulateTimeAndTest(10, 25);  // Should go to 11:15
    
    console.log('=====================================');
    console.log('üß™ Complete test finished');
}

// Make functions globally available for debugging
window.fetchMasterAPIData = fetchMasterAPIData;
window.updateReferenceStations = updateReferenceStations;
window.updateReferenceStationSquare = updateReferenceStationSquare;
window.testMasterAPI = testMasterAPI;
window.testScheduling = testScheduling;
window.debugMapState = debugMapState;
window.simulateTimeAndTest = simulateTimeAndTest;
window.setupHourlyScheduling = setupHourlyScheduling;
window.getContrastColor = getContrastColor;
window.runCompleteTest = runCompleteTest;

console.log('üì° Master API integration script loaded with enhanced debugging');

// ============================================================================
// AUTO-INITIALIZATION
// ============================================================================

// Variables de control para inicializaci√≥n
let masterAPIInitAttempts = 0;
const maxMasterAPIAttempts = 15;
let initializationCompleted = false;

function attemptMasterAPIInit() {
    // Evitar m√∫ltiples inicializaciones
    if (initializationCompleted) {
        console.log('‚úÖ Master API already initialized, skipping');
        return;
    }
    
    masterAPIInitAttempts++;
    
    if (masterAPIInitAttempts > maxMasterAPIAttempts) {
        console.log('‚è∞ Master API: Max initialization attempts reached');
        return;
    }
    
    console.log(`üîç Master API init attempt ${masterAPIInitAttempts}/${maxMasterAPIAttempts}`);
    
    // Verificar que todas las dependencias est√©n listas
    const dependencies = [
        window.map,
        window.map?.isStyleLoaded,
        window.map?.getLayer,
        window.MAP_LAYERS,
        window.MASTER_API_CONFIG,
        window.getTimeUntilNextScheduledUpdate
    ];
    
    const allDepsReady = dependencies.every(dep => !!dep);
    const mapReady = window.map?.isStyleLoaded();
    const layerReady = window.map?.getLayer('smaa_network_squares');
    
    console.log('üîç Dependencies check:', {
        allDeps: allDepsReady,
        mapReady: mapReady,
        layerReady: !!layerReady,
        hasConfig: !!window.MASTER_API_CONFIG,
        hasScheduling: !!window.getTimeUntilNextScheduledUpdate
    });
    
    if (allDepsReady && mapReady && layerReady) {
        console.log('‚úÖ All Master API prerequisites ready, initializing...');
        initializationCompleted = true;
        initializeMasterAPI();
    } else {
        console.log('‚è≥ Master API prerequisites not ready, retrying...');
        setTimeout(attemptMasterAPIInit, 1000);
    }
}

// Comenzar intentos de inicializaci√≥n
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOM loaded, starting Master API initialization attempts...');
    setTimeout(attemptMasterAPIInit, 3000); // Primer intento despu√©s de 3 segundos
});

// Tambi√©n intentar cuando se detecte que el mapa est√° listo
if (window.map) {
    window.map.on('sourcedata', (e) => {
        if (e.sourceId === window.MAP_LAYERS?.source && 
            e.isSourceLoaded && 
            !initializationCompleted) {
            console.log('üì° Map source loaded, attempting Master API init...');
            setTimeout(attemptMasterAPIInit, 1000);
        }
    });
}

// Fallback: intentar despu√©s de 10 segundos sin importar el estado
setTimeout(() => {
    if (!initializationCompleted && masterAPIInitAttempts === 0) {
        console.log('‚è∞ Fallback Master API initialization...');
        attemptMasterAPIInit();
    }
}, 10000);

// Backup fallback: forzar inicializaci√≥n despu√©s de 20 segundos
setTimeout(() => {
    if (!initializationCompleted) {
        console.log('üö® Force Master API initialization (backup)...');
        initializationCompleted = true;
        
        // Intentar inicializar directamente
        if (window.map) {
            initializeMasterAPI();
        } else {
            console.log('‚ùå Map still not available after 20 seconds');
        }
    }
}, 20000);

</script>

<!-- ============================================================================ -->
<!-- DEBUG BUTTONS - SOLO PARA DESARROLLO -->
<!-- ============================================================================ -->

<script>
// Agregar botones de debug mejorados (solo en desarrollo)
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    // Crear contenedor para m√∫ltiples botones
    const debugContainer = document.createElement('div');
    debugContainer.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 5px;
        background: rgba(255,255,255,0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;
    
    // T√≠tulo del panel
    const title = document.createElement('div');
    title.textContent = 'üß™ Master API Debug';
    title.style.cssText = `
        font-weight: bold;
        font-size: 12px;
        margin-bottom: 5px;
        text-align: center;
        color: #333;
    `;
    debugContainer.appendChild(title);
    
    // Bot√≥n de test completo
    const completeTestButton = document.createElement('button');
    completeTestButton.textContent = 'üî¨ Complete Test';
    completeTestButton.style.cssText = `
        padding: 8px 12px;
        background: #ff6b35;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        min-width: 140px;
    `;
    completeTestButton.onclick = () => {
        console.log('üî¨ Complete test button clicked');
        runCompleteTest();
    };
    
    // Bot√≥n principal de test API
    const testButton = document.createElement('button');
    testButton.textContent = 'üß™ Test API';
    testButton.style.cssText = `
        padding: 8px 12px;
        background: #4264fb;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        min-width: 140px;
    `;
    testButton.onclick = () => {
        console.log('üß™ API test button clicked');
        testMasterAPI();
    };
    
    // Bot√≥n de scheduling debug
    const scheduleButton = document.createElement('button');
    scheduleButton.textContent = '‚è∞ Check Schedule';
    scheduleButton.style.cssText = `
        padding: 8px 12px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        min-width: 140px;
    `;
    scheduleButton.onclick = () => {
        console.log('‚è∞ Schedule debug button clicked');
        testScheduling();
    };
    
    // Bot√≥n de map debug
    const mapButton = document.createElement('button');
    mapButton.textContent = 'üó∫Ô∏è Check Map';
    mapButton.style.cssText = `
        padding: 8px 12px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        min-width: 140px;
    `;
    mapButton.onclick = () => {
        console.log('üó∫Ô∏è Map debug button clicked');
        debugMapState();
    };
    
    // Agregar botones al contenedor
    debugContainer.appendChild(completeTestButton);
    debugContainer.appendChild(testButton);
    debugContainer.appendChild(scheduleButton);
    debugContainer.appendChild(mapButton);
    
    // Agregar contenedor al body
    document.body.appendChild(debugContainer);
    
    console.log('üß™ Enhanced debug panel added for Master API testing');
}
</script>
</body>
</html>
